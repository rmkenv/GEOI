name: Geospatial Value Investor (Saturdays)

on:
  schedule:
    - cron: '0 13 * * 6'  # Saturday 1 PM UTC
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install pyarrow pandas==2.2.* numpy yfinance requests

      - name: Generate reports
        run: |
          mkdir -p output
          python valueinvestortool.py \
            --parquet-url "https://github.com/rmkenv/GEOI/raw/main/final_geospatial_companies_with_cik.parquet" \
            --output output/geospatial-newsletter-$(date +%Y%m%d).md \
            --export-json output/analysis-$(date +%Y%m%d).json \
            --export-csv output/analysis-$(date +%Y%m%d).csv \
            --days 30 \
            --api-key "$ANTHROPIC_API_KEY"

      - name: Commit results
        run: |
          git config user.name github-actions
          git config user.email action@github.com
          git add output/ || true
          if ! git diff --staged --quiet; then
            git commit -m "Saturday reports [$(date +%Y-%m-%d)]"
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - uses: actions/upload-artifact@v4
        with:
          name: saturday-reports-${{ github.run_id }}
          path: |
            output/
